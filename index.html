<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name='admaven-placement' content=Bqjw7rjnF>
    <title>Quiz Islam - Vrai/Faux avanc√©</title>
    <style>
     
       @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        *{margin:0;padding:0;box-sizing:border-box}
        
        /* Minuteur Ramadan - en haut √† droite du menu */
#ramadanCountdown {
    position: absolute;
    top: 15px;
    left: 20px;
    background: rgba(255, 215, 0, 0.2); /* fond or tr√®s l√©ger */
    border: 2px solid #FFD700;
    border-radius: 12px;
    padding: 10px 16px;
    color: #FFD700;
    font-size: 1.3rem;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    z-index: 10;
    min-width: 220px;
}

#ramadanCountdown span {
    color: #e2e8f0;
    font-size: 1.1rem;
    display: block;
    margin-top: 4px;
}

@media (max-width: 600px) {
    #ramadanCountdown {
        position: static;
        margin: 15px auto;
        width: 90%;
        right: auto;
        top: auto;
    }
}


        /* COULEURS VERT/OR */
        body{
            font-family:'Amiri',serif;
            background:linear-gradient(135deg,#143C30,#1D483C); 
            color:#e2e8f0;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:15px;
            position:relative
        }

        .box{
            width:100%;
            max-width:500px;
            background:rgba(20,60,48,0.96); 
            border-radius:28px;
            padding:40px 30px;
            box-shadow:0 25px 70px rgba(0,0,0,0.8);
            border:2px solid #6B8E23; 
            text-align:center
        }

        h1{
            font-size:3.4rem;
            color:#FFD700; 
            text-shadow:0 0 30px #DAA520; 
            margin-bottom:20px
        }

        .menu-btn{
            display:block;
            width:88%;
            margin:20px auto;
            padding:22px;
            font-size:1.75rem;
            font-weight:700;
            color:#143C30;
            background:linear-gradient(135deg,#FFD700,#B8860B); 
            border:none;
            border-radius:60px;
            cursor:pointer;
            box-shadow:0 12px 35px rgba(255,215,0,0.5); 
            transition:all .4s
        }

        .menu-btn:hover{
            transform:translateY(-8px)
        }
        
        .menu-btn:disabled{
            background:linear-gradient(135deg,#475569,#64748b)!important;
            box-shadow:0 5px 15px rgba(0,0,0,0.5);
            transform:none!important;
            cursor:default;
        }

        .infinite-btn{
            background:linear-gradient(135deg,#a0522d,#cd853f)!important;
            color: #e2e8f0;
        }

        .success-btn{
            background:linear-gradient(135deg,#006400,#228b22)!important;
            color: #e2e8f0;
        }

        .danger-btn{
            background:linear-gradient(135deg,#8b0000,#dc143c)!important;
            font-size:1.4rem;
            padding:16px;
            color: #e2e8f0;
        }

        .settings-btn{
            background:linear-gradient(135deg,#4f4f4f,#696969);
            font-size:1.5rem;
            padding:18px;
            color: #e2e8f0;
        }

        .chrono-btn{
            background:linear-gradient(135deg,#800080,#9932cc)!important;
            color: #e2e8f0;
        }

        .leaderboard-btn{
            background:linear-gradient(135deg,#483d8b,#6a5acd)!important;
            color: #e2e8f0;
        }

        .qcm-btn{
            background:linear-gradient(135deg,#4682b4,#5f9ea0)!important;
            color: #e2e8f0;
        }

        .hidden{
            display:none
        }

        input{
            width:85%;
            padding:16px;
            margin:12px 0;
            border:none;
            border-radius:50px;
            font-size:1.3rem;
            text-align:center;
            background:#1E293B;
            color:#fff
        }

        .user-info{
            background:#6B8E23; 
            padding:15px;
            border-radius:20px;
            margin:20px 0;
            font-size:1.2rem
        }
        
        .user-info strong{
            color:#FFD700;
        }

        .stats{
            margin:15px 0;
            color:#C0C0C0;
        }

        .xp-bar{
            height:18px;
            background:#1e293b;
            border-radius:10px;
            overflow:hidden;
            margin:15px 0
        }

        .xp-fill{
            height:100%;
            background:linear-gradient(90deg,#DAA520,#FFD700); 
            width:0;
            border-radius:10px;
            transition:width 1s ease
        }

        .timer-bar{
            height:12px;
            background:#1e293b;
            border-radius:10px;
            overflow:hidden;
            margin:10px 0
        }

        .timer-fill{
            height:100%;
            background:linear-gradient(90deg,#388E3C,#FFD700); 
            width:100%;
            transition:width 1s linear
        }

        .timer-text{
            font-size:1.5rem;
            font-weight:700;
            color:#388E3C;
            margin-bottom:10px
        }

        .answers{
            display:flex;
            justify-content:center;
            align-items:center;
            gap:20px;
            margin:40px 20px 20px;
            flex-wrap:wrap
        }

        @media (max-width:480px){
            .answers{gap:15px;margin:30px 10px 15px}
        }

        .ans{
            flex:1 1 45%;
            min-width:120px;
            max-width:220px;
            padding:32px 20px;
            font-size:1.2rem;
            font-weight:700;
            color:#fff;
            border-radius:30px;
            cursor:pointer;
            transition:all .3s;
            box-shadow:0 12px 35px rgba(0,0,0,0.5);
            user-select:none;
            text-align:center
        }

        .ans:hover{
            transform:translateY(-8px);
            box-shadow:0 20px 50px rgba(0,0,0,0.7)
        }

        .ans.disabled{
            pointer-events:none;
            opacity:.5
        }
        
        .qcm-style .ans{
            flex:1 1 48%;
            min-width: unset;
            max-width: unset;
            padding: 20px 15px;
            font-size: 1.1rem;
        }

        .vrai{
            background:#388E3C;
        }

        .faux{
            background:#D32F2F;
        }

        .question{
            font-size:1.65rem;
            line-height:1.7;
            padding:35px 25px;
            background:rgba(30,41,59,0.9);
            border-radius:22px;
            border:2px solid #DAA52033; 
            min-height:150px;
            display:flex;
            align-items:center;
            justify-content:center;
            margin:25px 20px
        }

        .result{
            font-size:2.4rem;
            margin:25px 0;
            font-weight:700
        }

        .levelup{
            font-size:1.8rem;
            color:#FFFACD; 
            text-shadow:0 0 10px #FFD700;
            margin:15px 0
        }

        .exp{
            margin:25px;
            padding:22px;
            background:rgba(255,215,0,0.15); 
            border-left:6px solid #FFD700;
            border-radius:18px;
            font-size:1.25rem;
            line-height:1.7
        }

        #dailyQuizBtn.disabled{
            cursor:default;
            background:linear-gradient(135deg,#475569,#64748b)!important;
            box-shadow:0 5px 15px rgba(0,0,0,0.5);
            transform:none!important
        }

        #dailyTimerDisplay{
            display:block;
            font-size:1.1rem;
            color:#f87171;
            font-weight:700;
            margin-top:5px
        }

        .leaderboard-table{
            width:100%;
            border-collapse:collapse;
            margin:20px 0;
            font-size:1.2rem
        }

        .leaderboard-table th,.leaderboard-table td{
            padding:12px;
            border-bottom:1px solid #1e293b
        }

        .leaderboard-table th{
            background:#6B8E23; 
            color:#fff;
            font-size:1.3rem
        }

        .leaderboard-table td:first-child{
            font-weight:700
        }

        .user-row{
            background:rgba(20,60,48,0.96);
            border:3px solid #FFD700;
        }

        .popup{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%) scale(0);
            background:rgba(0,0,0,0.95);
            padding:40px 30px;
            border-radius:30px;
            border:4px solid #FFD700; 
            box-shadow:0 0 80px #FFD700; 
            z-index:9999;
            text-align:center;
            transition:all .5s ease;
            opacity:0;
            max-width:90%
        }

        .popup.show{
            transform:translate(-50%,-50%) scale(1);
            opacity:1
        }

        .popup h2{
            font-size:3rem;
            color:#FFD700;
            margin:20px 0
        }

        .popup .emoji{
            font-size:5rem;
            margin:15px 0
        }

        .popup p{
            font-size:1.6rem;
            color:#e2e8f0;
            white-space: pre-line;
        }

        .achievement{
            margin:18px auto;
            padding:18px;
            background:rgba(107,142,35,0.12);
            border-radius:20px;
            border:2px solid #6B8E23;
            max-width:400px;
            display:flex;
            align-items:center;
            gap:15px;
            font-size:1.1rem;
            transition:all .4s;
            opacity:.6
        }

        .achievement.unlocked{
            background:rgba(255,215,0,0.25)!important;
            border:3px solid #FFD700!important;
            box-shadow:0 0 30px #FFD70077;
            opacity:1
        }

        .achievement.unlocked .emoji{
            font-size:3rem!important
        }

        .achievement .emoji{
            font-size:2.2rem;
            opacity:.7
        }

        .daily-challenge-box{
            width:90%;
            max-width:380px;
            background-color:#6B8E23;
            border-radius:20px;
            padding:25px 20px;
            text-align:center;
            box-shadow:0 10px 30px rgba(0,0,0,0.5);
            color:#fff;
            margin:20px auto
        }

        .daily-challenge-box h2{
            font-size:1.8rem;
            font-weight:bold;
            text-transform:uppercase;
            margin-bottom:10px
        }

        .daily-challenge-box p{
            font-size:1.2rem;
            margin-bottom:25px;
            font-weight:500
        }

        .play-button{
            display:block;
            width:100%;
            margin:0 auto;
            padding:15px 30px;
            background-color:#FFD700;
            color:#143C30;
            font-size:1.7rem;
            font-weight:bold;
            text-decoration:none;
            text-transform:uppercase;
            border:none;
            border-radius:50px;
            cursor:pointer;
            transition:transform .2s,box-shadow .2s;
            box-shadow:0 12px 0 0 #143C30;
        }

        .play-button:hover{
            transform:translateY(-2px);
            box-shadow:0 15px 0 0 #143C30
        }

        .play-button:active{
            transform:translateY(8px);
            box-shadow:0 4px 0 0 #143C30
        }
        
        .shop-item {
            background:rgba(107,142,35,0.4);
            border:2px solid #6B8E23;
            border-radius:15px;
            padding:18px;
            text-align:left;
            box-shadow:0 8px 15px rgba(0,0,0,0.4);
        }

        .item-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px
        }

        .shop-item h3{
            font-size:1.7rem;
            color:#FFD700;
        }

        .shop-item .stock{
            font-size:1.2rem;
            color:#C0C0C0;
        }

        .item-desc{
            font-size:1.1rem;
            color:#e2e8f0;
            margin-bottom:15px
        }

        .item-footer{
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .item-footer .price{
            font-size:1.5rem;
            font-weight:700;
            color:#fff;
            display:flex;
            align-items:center; gap:10px;
        }

        .buy-btn{
            width:auto;
            padding:12px 20px;
            font-size:1.1rem;
            margin:0!important;
        }
        
        .buy-btn:disabled{
            background:linear-gradient(135deg,#475569,#64748b)!important;
            box-shadow:0 5px 15px rgba(0,0,0,0.5);
            transform:none!important;
            cursor:default;
        }
    </style>
</head>
<body>

<audio id="good" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-205.mp3"></audio>
<audio id="bad" src="https://assets.mixkit.co/sfx/preview/mixkit-negative-interface-beep-203.mp3"></audio>
<audio id="timeout" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-bass-548.mp3"></audio>
<audio id="levelup" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
<audio id="unlock" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3"></audio>

<div class="box">
    <div id="auth">
        <h1>Quiz Islam</h1>
        <p style="font-size:1.5rem;margin:25px 0;">Cr√©e un compte ou connecte-toi</p>
        <input type="text" id="pseudo" placeholder="Pseudo">
        <input type="password" id="password" placeholder="Mot de passe">
        <button class="menu-btn" onclick="login()">Se connecter</button>
        <button class="menu-btn settings-btn" onclick="register()">Cr√©er un compte</button>
    </div>

    <div id="menu" class="hidden">
        <h1>Quiz Islam</h1>
        <div id="ramadanCountdown">
            Event du ramadan 2026 dans...
            <span id="countdownTimer">Calcul en cours...</span>
        </div>
        <div class="user-info">
            Bienvenue <strong id="username"></strong> ‚Ä¢ Niveau <strong id="levelNum">1</strong>
            <br>üí∞ Points : <strong id="userPoints">0</strong>
        </div>
        <div class="stats">Streak : <span id="streak">0</span> | Record Infini : <span id="best">0</span></div>
        <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
        <div style="margin:15px 0;color:#94a3b8;">XP: <span id="xp">0</span>/<span id="xpMax">100</span></div>
            
        <div class="daily-challenge-box" id="dailyQuizBtnContainer">
            <h2>D√âFI DU JOUR</h2>
            <p>5 questions &rarr; **+200 XP si 5/5**</p>
            <button class="play-button" id="dailyQuizBtn" onclick="checkDailyQuizAvailability()">JOUER</button>
            <span id="dailyTimerDisplay" style="display:none;font-size:1.1rem;color:#f87171;font-weight:700;margin-top:15px;display:block;"></span>
        </div>
        
        <button class="menu-btn leaderboard-btn" onclick="showShop()">üõçÔ∏è Shop Quotidien</button>
        <button class="menu-btn" onclick="showDifficultyMenu()">Mode Classique (Difficult√©)</button>
        <button class="menu-btn qcm-btn" onclick="startQCM()">Mode QCM (10 Q. - 4 Choix)</button>
        <button class="menu-btn chrono-btn" onclick="startChrono()">Mode Chrono (10 Q. - 10s)</button>
        <button class="menu-btn infinite-btn" onclick="startInfinite()">Mode Infini (1 Faute = Perdu)</button>
        <button class="menu-btn leaderboard-btn" onclick="showLeaderboard()">Classement</button>
        <button class="menu-btn success-btn" onclick="showAchievements()">Succ√®s</button>
        <button class="menu-btn settings-btn" onclick="showSettings()">Param√®tres</button>
    </div>
    
    <div id="shop" class="hidden">
        <h1>üõçÔ∏è Shop Quotidien</h1>
        <p style="font-size:1.4rem;margin-bottom:20px;color:#FFD700;">Les offres changent tous les jours !</p>
        <div id="shopChrono" style="font-size: 1.3rem; font-weight: bold; color: #f87171; margin-bottom: 20px;"></div>
        <div id="shopItemsContainer" style="display:flex;flex-direction:column;gap:20px;"></div>
        <h2 style="margin-top:40px;margin-bottom:15px;color:#6B8E23;">Inventaire</h2>
        <ul id="ownedItemsList" style="list-style:none;text-align:left;padding:0 20px;font-size:1.3rem;"></ul>
        <button class="menu-btn settings-btn" onclick="showMenu()">Retour au menu</button>
    </div>

    <div id="leaderboard" class="hidden">
        <h1>Classement</h1>
        <table class="leaderboard-table" id="leaderboardTable">
            <thead>
                <tr><th>#</th><th>Joueur</th><th>Total XP</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="menu-btn" onclick="showMenu()">Retour</button>
    </div>

    <div id="achievements" class="hidden">
        <h1>Succ√®s</h1>
        <div class="achievement" id="a1"><span class="emoji">üë∂</span><div><strong>Premier pas</strong><br><span id="a1-prog"></span></div></div>
        <div class="achievement" id="a2"><span class="emoji">üíØ</span><div><strong>10/10 Parfait !</strong><br><span id="a2-prog"></span></div></div>
        <div class="achievement" id="a3"><span class="emoji">üî•</span><div><strong>Streak de feu</strong><br><span id="a3-prog"></span></div></div>
        <div class="achievement" id="a4"><span class="emoji">‚ôæÔ∏è</span><div><strong>Infini 50</strong><br><span id="a4-prog"></span></div></div>
        <div class="achievement" id="a5"><span class="emoji">‚è±Ô∏è</span><div><strong>Vitesse √âclair</strong><br><span id="a5-prog"></span></div></div>
        <div class="achievement" id="a6"><span class="emoji">‚≠ê</span><div><strong>1000 XP</strong><br><span id="a6-prog"></span></div></div>
        <div class="achievement" id="a7"><span class="emoji">üìö</span><div><strong>Savant en devenir</strong><br><span id="a7-prog"></span></div></div>
        <div class="achievement" id="a8"><span class="emoji">üèÜ</span><div><strong>Ma√Ætre du Vrai/Faux</strong><br><span id="a8-prog"></span></div></div>
        <div class="achievement" id="a9"><span class="emoji">üìø</span><div><strong>Hafiz</strong><br><span id="a9-prog"></span></div></div>
        <div class="achievement" id="a11"><span class="emoji">üß†</span><div><strong>QCM Initi√©</strong><br><span id="a11-prog"></span></div></div>
        <div class="achievement" id="a12"><span class="emoji">‚úÖ</span><div><strong>Ma√Ætre QCM</strong><br><span id="a12-prog"></span></div></div>
        <div class="achievement" id="a10"><span class="emoji">üíé</span><div><strong>L√©gende de la oumma</strong><br><span id="a10-prog"></span></div></div>
        <button class="menu-btn" onclick="showMenu()">Retour</button>
    </div>

    <div id="settings" class="hidden">
        <h1>Param√®tres</h1>
        <div class="user-info">Connect√© : <strong id="username2"></strong><br>Niveau <strong id="levelNum2">1</strong> ‚Ä¢ XP total : <strong id="totalXp">0</strong></div>
        <button class="menu-btn infinite-btn" onclick="useDailyReroll()">Utiliser Daily Reroll (Poss√©d√© : <span id="rerollCount">0</span>)</button>
        <button class="menu-btn" onclick="showMenu()">Retour au menu</button>
        <button class="menu-btn danger-btn" onclick="resetAccount()">R√©initialiser mon compte</button>
        <button class="menu-btn settings-btn" onclick="logout()">D√©connexion</button>
    </div>

    <div id="difficultyMenu" class="hidden">
        <h1>Choix de la Difficult√©</h1>
        <p style="font-size:1.4rem;margin-bottom:25px;color:#94a3b8;">10 questions par partie. Gagnez des **points** en r√©pondant correctement.</p>
        <button class="menu-btn" onclick="startClassic(1)">Facile (1 XP/Q)</button>
        <button class="menu-btn chrono-btn" onclick="startClassic(2)">Normal (10 XP/Q)</button>
        <button class="menu-btn infinite-btn" onclick="startClassic(3)">Difficile (15 XP/Q)</button>
        <button class="menu-btn settings-btn" onclick="showMenu()">Retour au menu</button>
    </div>

    <div id="game" class="hidden">
        <h1 id="gameTitle">Quiz Islam</h1>
        <div class="stats" id="gameProgress"></div>
        <div id="timerContainer" class="hidden">
            <div class="timer-text" id="timerText"></div>
            <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
        </div>
        <div class="question" id="q">Pr√™t ?</div>
        <div class="answers" id="answers"></div>
        <div class="result" id="result"></div>
        <div class="levelup hidden" id="levelUp">NIVEAU UP !</div>
        <div class="exp" id="exp"></div>
        <button class="menu-btn chrono-btn" id="hintBtn" onclick="useHint()" style="width:50%;margin-top:10px;">Utiliser Indice (<span id="hintCount">0</span>)</button>
        <button class="menu-btn hidden" id="nextBtn" onclick="nextQuestion()">Question Suivante</button>
        <button class="menu-btn hidden" id="restartBtn" onclick="showMenu()">Retour au menu principal</button>
    </div>
</div>

<div class="popup" id="popup">
    <div class="emoji" id="popupEmoji">üèÜ</div>
    <h2 id="popupTitle">Succ√®s d√©bloqu√© !</h2>
    <p id="popupText">MashaAllah akhi !</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, set, get, update, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMJ7E_pQuy2b2T82DrXqSZH_e1zJcAjzs",
    authDomain: "islamic-quiz-620fb.firebaseapp.com",
    projectId: "islamic-quiz-620fb",
    storageBucket: "islamic-quiz-620fb.firebasestorage.app",
    messagingSenderId: "1076586266222",
    appId: "1:1076586266222:web:109cfd4a53f4c04587307f",
    measurementId: "G-489R2S2RB4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Exportation pour le script classique
  window.db = db;
  window.ref = ref;
  window.set = set;
  window.get = get;
  window.update = update;
  window.child = child;
</script>

<script>
    // QUESTIONS ET LOGIQUE DE JEU (Tout le code d'origine)
    const questions = [
        {q: "La sourate la plus courte du Coran est Al-Kawthar.", a: true, e: "Elle ne comporte que 3 versets.", diff: 1},
        {q: "Le Proph√®te Muhammad Ô∑∫ a eu 4 filles.", a: true, e: "Zaynab, Ruqayya, Umm Kulthum et Fatima.", diff: 1},
        {q: "La pri√®re de Tarawih se fait uniquement pendant le mois de Ramadan.", a: true, e: "Elle est sp√©cifique au Ramadan.", diff: 1},
        {q: "Le hijab est obligatoire pour les hommes en Islam.", a: false, e: "Il concerne les femmes ; les hommes doivent s'habiller modestement.", diff: 1},
        {q: "La premi√®re r√©v√©lation a √©t√© re√ßue dans la grotte de Hira.", a: true, e: "C'est l√† que l'ange Jibril est venu avec 'Iqra'.", diff: 1},
        {q: "Le mois de Muharram est le premier mois du calendrier islamique.", a: true, e: "Il marque le d√©but de l'ann√©e h√©girienne.", diff: 1},
        {q: "Il est permis de manger du porc s'il est bien cuit.", a: false, e: "Le porc reste interdit en toute circonstance.", diff: 1},
        {q: "La sourate Al-Ikhlas parle de l'unicit√© d'Allah.", a: true, e: "Elle est appel√©e 'l'√©quivalent du tiers du Coran'.", diff: 1},
        {q: "Le Proph√®te Ô∑∫ est mort √† l‚Äô√¢ge de 63 ans.", a: true, e: "En l'an 11 de l'H√©gire, √† M√©dine.", diff: 1},
        {q: "La pri√®re du vendredi (Jumu'a) remplace la pri√®re du Dhuhr.", a: true, e: "Elle compte pour le Dhuhr du vendredi.", diff: 1},
        // Ajoutez ici le reste de vos questions...
    ];

    let currentUser = null;
    let xp = 0, totalXp = 0, points = 0, level = 1, best = 0, streak = 0;
    let items = { hints: 0, rerolls: 0, shields: 0 };
    let unlockedAchievements = [];
    let lastDailyDate = null;

    // --- LOGIQUE FIREBASE ---

    async function login() {
        const p = document.getElementById('pseudo').value.trim();
        const pass = document.getElementById('password').value;
        if(!p || !pass) return alert("Remplis tout !");

        const snapshot = await get(ref(window.db, 'users/' + p));
        if(snapshot.exists()) {
            const data = snapshot.val();
            if(data.password === pass) {
                currentUser = p;
                loadUserData(data);
                showMenu();
            } else {
                alert("Mot de passe incorrect");
            }
        } else {
            alert("Compte inexistant. Cr√©e un compte !");
        }
    }

    async function register() {
        const p = document.getElementById('pseudo').value.trim();
        const pass = document.getElementById('password').value;
        if(!p || !pass) return alert("Remplis tout !");

        const snapshot = await get(ref(window.db, 'users/' + p));
        if(snapshot.exists()) return alert("Ce pseudo existe d√©j√† !");

        const newData = {
            password: pass,
            xp: 0, totalXp: 0, points: 0, level: 1, best: 0, streak: 0,
            items: { hints: 0, rerolls: 0, shields: 0 },
            unlockedAchievements: [],
            lastDailyDate: null
        };

        await set(ref(window.db, 'users/' + p), newData);
        currentUser = p;
        loadUserData(newData);
        showMenu();
    }

    function loadUserData(data) {
        xp = data.xp || 0;
        totalXp = data.totalXp || 0;
        points = data.points || 0;
        level = data.level || 1;
        best = data.best || 0;
        streak = data.streak || 0;
        items = data.items || { hints: 0, rerolls: 0, shields: 0 };
        unlockedAchievements = data.unlockedAchievements || [];
        lastDailyDate = data.lastDailyDate;
    }

    async function saveStats() {
        if(!currentUser) return;
        const updates = {
            xp, totalXp, points, level, best, streak,
            items, unlockedAchievements, lastDailyDate
        };
        await update(ref(window.db, 'users/' + currentUser), updates);
    }

    // --- LOGIQUE DE JEU (ORIGINALE) ---

    function showScreen(id) {
        document.querySelectorAll('.box > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function updateStats() {
        document.getElementById('username').textContent = currentUser;
        document.getElementById('username2').textContent = currentUser;
        document.getElementById('levelNum').textContent = level;
        document.getElementById('levelNum2').textContent = level;
        document.getElementById('userPoints').textContent = points;
        document.getElementById('totalXp').textContent = totalXp;
        document.getElementById('xp').textContent = xp;
        document.getElementById('best').textContent = best;
        document.getElementById('streak').textContent = streak;
        document.getElementById('rerollCount').textContent = items.rerolls;
        document.getElementById('hintCount').textContent = items.hints;

        const xpMax = level * 100;
        document.getElementById('xpMax').textContent = xpMax;
        document.getElementById('xpFill').style.width = (xp / xpMax * 100) + "%";
    }

    // ... Int√©grez ici toutes vos fonctions d'origine : startClassic, startInfinite, checkAns, etc.
    // IMPORTANT : Appelez `saveStats()` √† chaque fois que l'XP ou les Points changent.

    function showMenu() {
        showScreen("menu");
        updateStats();
        initRamadanCountdown();
    }

    async function showLeaderboard() {
        showScreen("leaderboard");
        const snapshot = await get(ref(window.db, 'users'));
        const table = document.getElementById('leaderboardTable').getElementsByTagName('tbody')[0];
        table.innerHTML = "";
        
        let users = [];
        snapshot.forEach(child => {
            users.push({name: child.key, totalXp: child.val().totalXp});
        });

        users.sort((a,b) => b.totalXp - a.totalXp);
        users.forEach((u, i) => {
            let row = table.insertRow();
            if(u.name === currentUser) row.className = "user-row";
            row.insertCell(0).textContent = i + 1;
            row.insertCell(1).textContent = u.name;
            row.insertCell(2).textContent = u.name === currentUser ? totalXp : u.totalXp;
        });
    }

    function logout() {
        currentUser = null;
        showScreen('auth');
    }

    // Minuteur Ramadan d'origine
    function initRamadanCountdown() {
        const ramadanDate = new Date(\"March 1, 2026 00:00:00\").getTime();
        function updateCountdown() {
            const now = new Date().getTime();
            const diff = ramadanDate - now;
            if (diff <= 0) {
                document.getElementById('countdownTimer').textContent = \"Ramadan Mubarak üåô\";
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('countdownTimer').textContent = `${days}j ${hours}h ${minutes}m ${seconds}s`;
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
</script>
</body>
</html>
